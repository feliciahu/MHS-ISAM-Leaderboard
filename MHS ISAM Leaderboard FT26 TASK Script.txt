-- SELECT TOP 100* FROM DEV_ENT_PL_DATALAKE_DB.VARICENT.V_PE_ASSIGENED_UNASSIGNED_NET_SALES  


SHOW TASKS LIKE 'TSK_FELICIA_H_MHS_FY26_LEADERBOARD_ISAM%';
DESC TASK TSK_FELICIA_H_MHS_FY26_LEADERBOARD_ISAM;
execute task TSK_FELICIA_H_MHS_FY26_LEADERBOARD_ISAM;

select *  from table(SBX_PSAS_DB.INFORMATION_SCHEMA.task_history(
scheduled_time_range_start=>dateadd('day',-7,current_timestamp()),
result_limit => 10,
task_name=>'TSK_FELICIA_H_MHS_FY26_LEADERBOARD_ISAM'));
    
alter task TSK_FELICIA_H_MHS_FY26_LEADERBOARD_ISAM resume; --It was by default suspended  ( run this command Only first time since by default its suspended)


--TASK
CREATE OR REPLACE TASK TSK_FELICIA_H_MHS_FY26_LEADERBOARD_ISAM
WAREHOUSE = SBX_EA_GENERAL_FR_WH
SCHEDULE = 'USING CRON 50 6 * * 1-5 America/Chicago' -- 6:50 AM on weekdays
TIMESTAMP_INPUT_FORMAT = 'YYYY-MM-DD HH24'
AS

CREATE OR REPLACE TABLE SBX_PSAS_DB.SALES_OPS_GOV.FY26_LEADERBOARD_ISAM_MHS AS
WITH 
--PULL MAX SALES DATE FOR ACTUALS
-- CREATE OR REPLACE TABLE 
HIER AS (SELECT *
FROM SBX_PSAS_DB.SALES_OPS_GOV.ISAM_MHS_MAPPING_HIST),

GOAL_PREP AS (
SELECT DISTINCT * FROM DEV_ENT_PL_DATALAKE_DB.VARICENT.V_PE_ACCOUNT_GOALS),

GOAL_PREP2 AS (
SELECT CASE WHEN GOALS.CALENDARMONTH='APRIL 2025' THEN '2026-01 APR'
     WHEN GOALS.CALENDARMONTH='MAY 2025' THEN '2026-02 MAY'
     WHEN GOALS.CALENDARMONTH='JUNE 2025' THEN '2026-03 JUN'
     WHEN GOALS.CALENDARMONTH='JULY 2025' THEN '2026-04 JUL'
     WHEN GOALS.CALENDARMONTH='AUGUST 2025' THEN '2026-05 AUG'
     WHEN GOALS.CALENDARMONTH='SEPTEMBER 2025' THEN '2026-06 SEP'
     WHEN GOALS.CALENDARMONTH='OCTOBER 2025' THEN '2026-07 OCT'
     WHEN GOALS.CALENDARMONTH='NOVEMBER 2025' THEN '2026-08 NOV'
     WHEN GOALS.CALENDARMONTH='DECEMBER 2025' THEN '2026-09 DEC'
     WHEN GOALS.CALENDARMONTH='JANUARY 2026' THEN '2026-10 JAN'
     WHEN GOALS.CALENDARMONTH='FEBRUARY 2026' THEN '2026-11 FEB'
ELSE '2026-12 MAR' END AS PERIOD,
GOALS.ACCOUNTID AS CUST_ACCT_ID,
CUST.CUST_ACCT_NAM,
GOALS.PRODUCTIDENTIFIER AS SEGMENT,
CUST.CUST_BUS_TYP_CD,
CUST.CUST_BUS_TYP_DSCR,
CUST.COMMON_ENTITY_ID,
CUST.COMMON_ENTITY_NAME,
CUST.SLS_TERR_ID,
CUST.ACCT_340B_ID,
CUST.DRUG_340B_ACCT_FLG,
SUM(GOALS.TARGETVALUE) AS GOALS
FROM GOAL_PREP GOALS
JOIN PRD_PSAS_DB.EDWRPT.DIM_CUST_ACCT_CURR CUST
ON LTRIM(GOALS.ACCOUNTID,'0')=LTRIM(CUST.CUST_ACCT_ID,'0')
WHERE GOALS.CALENDARMONTH IN ('APRIL 2025','MAY 2025','JUNE 2025','JULY 2025','AUGUST 2025','SEPTEMBER 2025','OCTOBER 2025','NOVEMBER 2025','DECEMBER 2025','JANUARY 2026','FEBRUARY 2026','MARCH 2026')
AND GOALS.PRODUCTGROUP='NET SALES'
AND CUST.ACTIVE_CUST_IND='A'
GROUP BY 1,2,3,4,5,6,7,8,9,10,11),

GOAL AS (
SELECT GOAL_PREP2.*,
HIER.OWNER_NAME__C AS ISAM
FROM GOAL_PREP2 GOAL_PREP2
JOIN HIER HIER
ON LTRIM(GOAL_PREP2.CUST_ACCT_ID,'0')=LTRIM(HIER.ACCOUNTNUMBER,'0')
AND GOAL_PREP2.PERIOD=HIER.PERIOD_MAPPING),

ACTUAL_PREP AS (
-- SELECT MAX(__LOAD_TIMESTAMP__) FROM DEV_ENT_PL_DATALAKE_DB.VARICENT.V_PE_ASSIGENED_UNASSIGNED_NET_SALES WHERE ACCOUNTID='184984' AND PERIOD='2025-10 JAN';
SELECT DISTINCT ACTUALS.PERIOD,
ACTUALS.ACCOUNTID AS CUST_ACCT_ID,
CUST.CUST_ACCT_NAM,
ACTUALS.PAYEEID,
HIER.OWNER_NAME__C AS ISAM,
CUST.CUST_BUS_TYP_CD,
CUST.CUST_BUS_TYP_DSCR,
CUST.COMMON_ENTITY_ID,
CUST.COMMON_ENTITY_NAME,
CUST.SLS_TERR_ID,
CUST.ACCT_340B_ID,
CUST.DRUG_340B_ACCT_FLG,
ACTUALS.PRODUCTCATEGORYID AS SEGMENT_PREP,
SUM(ACTUALS.SALESAMOUNT) AS ACTUALS_PREP
FROM DEV_ENT_PL_DATALAKE_DB.VARICENT.V_PE_ASSIGENED_UNASSIGNED_NET_SALES ACTUALS
JOIN HIER HIER
ON LTRIM(ACTUALS.ACCOUNTID,'0')=LTRIM(HIER.ACCOUNTNUMBER,'0')
AND ACTUALS.PERIOD=HIER.PERIOD_MAPPING
JOIN PRD_PSAS_DB.EDWRPT.DIM_CUST_ACCT_CURR CUST
ON LTRIM(ACTUALS.ACCOUNTID,'0')=LTRIM(CUST.CUST_ACCT_ID,'0')
WHERE ACTUALS.PERIOD LIKE '%2026%'
AND ACTUALS.PRODUCTCATEGORYID IN ('MPB','MPBS','PHARMA')
GROUP BY 1,2,3,4,5,6,7,8,9,10,11,12,13),

ACTUAL AS (
SELECT DISTINCT PERIOD,
CUST_ACCT_ID,
CUST_ACCT_NAM,
ISAM,
CUST_BUS_TYP_CD,
CUST_BUS_TYP_DSCR,
COMMON_ENTITY_ID,
COMMON_ENTITY_NAME,
SLS_TERR_ID,
ACCT_340B_ID,
DRUG_340B_ACCT_FLG,
CASE WHEN SEGMENT_PREP IN ('MPB','MPBS') THEN 'MPB'
ELSE 'PHARMA' END AS SEGMENT,
SUM(ACTUALS_PREP)/COUNT(PAYEEID) AS ACTUALS
FROM ACTUAL_PREP
GROUP BY 1,2,3,4,5,6,7,8,9,10,11,12)

SELECT GOAL.PERIOD,
GOAL.CUST_ACCT_ID,
GOAL.CUST_ACCT_NAM,
GOAL.SEGMENT,
GOAL.ISAM,
GOAL.COMMON_ENTITY_ID,
GOAL.COMMON_ENTITY_NAME,
GOAL.CUST_BUS_TYP_CD,
GOAL.CUST_BUS_TYP_DSCR,
GOAL.SLS_TERR_ID,
GOAL.ACCT_340B_ID,
GOAL.DRUG_340B_ACCT_FLG,
SUM(GOAL.GOALS) AS "GOALS",
SUM(ACTUAL.ACTUALS) AS "ACTUALS"
FROM GOAL GOAL
LEFT JOIN ACTUAL ACTUAL
ON LTRIM(ACTUAL.CUST_ACCT_ID,'0')=LTRIM(GOAL.CUST_ACCT_ID,'0')
AND ACTUAL.PERIOD=GOAL.PERIOD
AND ACTUAL.SEGMENT=GOAL.SEGMENT
GROUP BY 1,2,3,4,5,6,7,8,9,10,11,12
UNION
SELECT ACTUAL.PERIOD,
ACTUAL.CUST_ACCT_ID,
ACTUAL.CUST_ACCT_NAM,
ACTUAL.SEGMENT,
ACTUAL.ISAM,
ACTUAL.COMMON_ENTITY_ID,
ACTUAL.COMMON_ENTITY_NAME,
ACTUAL.CUST_BUS_TYP_CD,
ACTUAL.CUST_BUS_TYP_DSCR,
ACTUAL.SLS_TERR_ID,
ACTUAL.ACCT_340B_ID,
ACTUAL.DRUG_340B_ACCT_FLG,
SUM(GOAL.GOALS) AS "GOALS",
SUM(ACTUAL.ACTUALS) AS "ACTUALS"
FROM ACTUAL ACTUAL
LEFT JOIN GOAL GOAL
ON LTRIM(ACTUAL.CUST_ACCT_ID,'0')=LTRIM(GOAL.CUST_ACCT_ID,'0')
AND ACTUAL.PERIOD=GOAL.PERIOD
AND ACTUAL.SEGMENT=GOAL.SEGMENT
GROUP BY 1,2,3,4,5,6,7,8,9,10,11,12

-- SELECT TOP 10* FROM DEV_ENT_PL_DATALAKE_DB.VARICENT.V_PE_ASSIGENED_UNASSIGNED_NET_SALES WHERE ACCOUNTID='520489'
-- SELECT * FROM SBX_PSAS_DB.SALES_OPS_GOV.FY26_LEADERBOARD_ISAM_MHS WHERE CUST_ACCT_ID='520489'

